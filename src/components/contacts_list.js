import React, { Component } from 'react';
import _ from 'lodash';
import { Pagination } from 'antd';
import ContactCard from './contact_card';


export default class ContactsList extends Component{

    constructor(props){
        super(props)

        this.state = {
            data: {},
            contacts: {},
            contactsPerPage: 0,
            currentPage:1
        }
    }

    componentDidMount() {
        this.loadProfilesFromState();
    }

    componentDidUpdate(){
            if ( (this.state.contacts !== this.props.contacts) || (this.state.contactsPerPage !== this.props.perPage)){
                // if the objects are the same size, send current page as offset, if not, might be a new search
                // reset the offset to 0 so we can start at the first page
                const selected = Object.keys(this.state.contacts).length === Object.keys(this.props.contacts).length ?
                                this.state.currentPage-1 : 0
                let offset = Math.ceil(selected * this.props.perPage);
                this.setState({
                    contacts: this.props.contacts,
                    contactsPerPage: this.props.perPage
                })
                this.loadProfilesFromState(offset)    
            }
    }

    firstN = (obj, offset) => {
        return Object.keys(obj) //get the keys out
          .sort() //this will ensure consistent ordering of what you will get back.
          .slice(offset, offset+this.props.perPage) //get the first N to M
          .reduce(function(memo, current) { //generate a new object out of them
            memo[current] = obj[current]
            return memo;
          }, {})
      }

    loadProfilesFromState = (offset=0, page=1) => {
            this.setState({data: this.firstN(this.props.contacts, offset)})
    }

    renderCards = () => {
        return _.map(this.state.data, (contact) => {
            return (<ContactCard key={contact["Email Address"]} 
                                contact={contact} 
                                name={contact["First Name"]} 
                    />)
        })
    }

    onShowSizeChange =(current, pageSize) => {
        this.setState({ currentPage: 1});
        this.props.setPerPage(pageSize)
      }

    handlePageClick = (page, pageSize) => {
        let selected = page-1;
        let offset = Math.ceil(selected * this.props.perPage);
        this.setState({offset: offset, currentPage: page});
        this.loadProfilesFromState(offset, page)};
      
    render(){
            const paginator = <Pagination 
                                        current = {this.state.currentPage}
                                        total={this.props.results} 
                                        onChange={this.handlePageClick} 
                                        pageSize={this.props.perPage}
                                        pageSizeOptions={['12', '24', '36', '48', '60', '72','84', '96']}
                                        showQuickJumper
                                        showSizeChanger 
                                        onShowSizeChange={this.onShowSizeChange}                                      
                                        />         
            return(
                        <div >
                            <div className="container-fluid">
                                <div className="card-decks">
                                            {this.renderCards()}
                                </div>
                            </div>             
                            {_.isEmpty(this.state.data)? <div /> : paginator}
                        </div>

            );
    }
  }